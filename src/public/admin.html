<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>管理后台 - 链接生成</title>
  <style>
    :root {
      --bg: #121826;
      --panel: #182235;
      --panel-2: #1a2740;
      --muted: #9fb0c8;
      --text: #f2f6fb;
      --accent: #5b8cff;
      --accent-2: #7aefbd;
      --danger: #ff6b6b;
      --ring: rgba(91,140,255,0.38);
      --shadow: 0 10px 30px rgba(0,0,0,0.28);
      --border: rgba(255,255,255,0.16);
    }
    body {
      margin: 0; padding: 24px; color: var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, rgba(91,140,255,0.07), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(122,239,189,0.06), transparent 60%),
                  var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
    }
    .container { max-width: 1060px; margin: 0 auto; }
    .panel { background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); border: 1px solid var(--border); border-radius: 14px; padding: 20px; box-shadow: var(--shadow); backdrop-filter: blur(8px); }
    h1 { margin: 0 0 16px; text-align:center; }
    p.sub { margin: -4px 0 18px; text-align:center; color: var(--muted); }
    form { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; margin-bottom: 16px; }
    label { display: flex; flex-direction: column; font-weight: 600; font-size: 13px; gap: 6px; }
    input, textarea {
      padding: 10px 12px; font-size: 14px; color: var(--text); background: var(--panel);
      border: 1px solid var(--border); border-radius: 10px; outline: none; transition: box-shadow .2s, border-color .2s, background .2s;
    }
    input:focus, textarea:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--accent); background: #1d2a40; }
    button { padding: 10px 16px; font-size: 14px; cursor: pointer; border: none; border-radius: 10px; color: #fff; background: linear-gradient(135deg, var(--accent), #2e6bff); box-shadow: 0 6px 18px rgba(91,140,255,0.35); }
    button:hover { filter: brightness(1.05); }
    .row-1col { grid-column: span 2; }
    .links { background: var(--panel-2); border: 1px dashed var(--border); padding: 12px; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; overflow: hidden; border-radius: 10px; }
    th, td { border: 1px solid var(--border); padding: 10px; }
    th { background: #0f1724; text-align: left; color: var(--muted); font-weight: 600; }
    tr:nth-child(odd) td { background: rgba(255,255,255,0.04); }
    code { background: #0f1724; padding: 2px 6px; border-radius: 6px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin: 10px 0; overflow:auto; }
    .toolbar input { flex: 1; }
    .btn-danger { background: linear-gradient(135deg, var(--danger), #e25555); box-shadow: 0 6px 18px rgba(255,107,107,0.25); }
    @media (max-width: 900px) { form { grid-template-columns: 1fr; } .row-1col { grid-column: span 1; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel" style="margin-bottom:16px">
      <h1>管理后台</h1>
      <p class="sub">生成含 token 的下载链接，支持搜索与删除</p>
      <form id="genForm">
      <label>
        生成数量
        <input type="number" min="1" max="1000" name="count" value="1" />
      </label>
      <label>
        每个链接下载次数上限（留空为不限）
        <input type="number" min="1" name="maxDownloads" />
      </label>
      <label>
        有效期（YYYY-MM-DD，留空为不限）
        <input type="date" name="expiresAt" />
      </label>
      <label class="row-1col">
        备注（选填）
        <textarea name="note" rows="2"></textarea>
      </label>
      <div class="row-1col">
        <button type="submit">生成链接</button>
      </div>
      </form>
      <div id="created" class="links" style="display:none"></div>
    </div>

    <div class="panel">
      <h2 style="margin:0 0 8px">链接列表</h2>
      <div id="stats" style="margin-bottom:10px; color: var(--muted); font-size: 13px;">
        加载统计中...
      </div>
      <div class="toolbar">
        <input id="search" placeholder="搜索 token 或备注" />
        <button id="btnSearch">搜索</button>
        <button id="btnClear">清空</button>
      </div>
      <div style="overflow:auto; -webkit-overflow-scrolling: touch; border-radius:10px;">
      <table id="tbl" style="min-width:860px;">
      <thead>
        <tr>
          <th>Token</th>
          <th>下载次数</th>
          <th>上限</th>
          <th>有效期</th>
          <th>备注</th>
          <th>创建时间</th>
          <th>链接</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
      </table>
      </div>
    </div>
  </div>
  <script>
    async function refresh() {
      const q = document.getElementById('search').value.trim();
      const url = q ? `/api/admin/links?q=${encodeURIComponent(q)}` : '/api/admin/links';
      const res = await fetch(url);
      const json = await res.json();
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      (json.data || []).forEach(r => {
        const tr = document.createElement('tr');
        const url = `${location.origin}/download?token=${encodeURIComponent(r.token)}`;
        tr.innerHTML = `
          <td><code>${r.token}</code></td>
          <td>${r.downloads_used}</td>
          <td>${r.max_downloads ?? '-'}</td>
          <td>${r.expires_at ?? '-'}</td>
          <td>${r.note ?? ''}</td>
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td><a href="${url}" target="_blank">打开</a></td>
          <td><button data-token="${r.token}" class="btnDel">删除</button></td>
        `;
        tbody.appendChild(tr);
      });
      // bind delete buttons
      document.querySelectorAll('.btnDel').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const token = e.currentTarget.getAttribute('data-token');
          if (!confirm(`确定删除 token: ${token} ?`)) return;
          const resp = await fetch(`/api/admin/links/${encodeURIComponent(token)}`, { method: 'DELETE' });
          if (!resp.ok) {
            const t = await resp.text();
            alert(t || '删除失败');
          }
          refresh();
        });
      });
      // refresh stats
      try {
        const s = await fetch('/api/admin/stats');
        const sj = await s.json();
        const bytes = Number(sj.totalBytes || 0);
        // format bytes
        function formatBytes(b) {
          if (b < 1024) return `${b} B`;
          if (b < 1024*1024) return `${(b/1024).toFixed(1)} KB`;
          if (b < 1024*1024*1024) return `${(b/1024/1024).toFixed(1)} MB`;
          return `${(b/1024/1024/1024).toFixed(2)} GB`;
        }
        document.getElementById('stats').textContent = `下载成功次数：${sj.totalDownloads || 0}，累计流量：${formatBytes(bytes)}`;
      } catch (_) {
        document.getElementById('stats').textContent = '';
      }
    }
    refresh();

    document.getElementById('genForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const body = Object.fromEntries(new FormData(form).entries());
      if (body.maxDownloads === '') delete body.maxDownloads;
      if (body.expiresAt === '') delete body.expiresAt;
      const res = await fetch('/api/admin/links', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
      });
      const json = await res.json();
      const div = document.getElementById('created');
      if (json.data) {
        // Keep created links panel hidden; download handled via backend export
        div.style.display = 'none';
        div.innerHTML = '';
        // Request backend to export a TXT (better on mobile/tablet and preserves headers/encoding)
        try {
          const resp = await fetch('/api/admin/links/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              tokens: (json.data || []).map(x => x.token),
              count: body.count,
              expiresAt: body.expiresAt,
              maxDownloads: body.maxDownloads,
              note: body.note
            })
          });
          if (resp.ok) {
            const blob = await resp.blob();
            const a = document.createElement('a');
            const urlObj = URL.createObjectURL(blob);
            a.href = urlObj;
            a.download = '';
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(urlObj), 1000);
          }
        } catch (_) {}
      }
      refresh();
    });

    document.getElementById('btnSearch').addEventListener('click', () => refresh());
    document.getElementById('btnClear').addEventListener('click', () => { document.getElementById('search').value=''; refresh(); });
  </script>
  </body>
  </html>



